<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.neusoft.coursemgr.mapper.OrderMapper">

    <resultMap id="OrderResultMap" type="com.neusoft.coursemgr.domain.Order">
        <id property="id" column="id" />
        <result property="orderNo" column="order_no" />
        <result property="userId" column="user_id" />
        <result property="status" column="status" />
        <result property="totalAmount" column="total_amount" />
        <result property="receiverName" column="receiver_name" />
        <result property="receiverPhone" column="receiver_phone" />
        <result property="receiverAddress" column="receiver_address" />
        <result property="payTime" column="pay_time" />
        <result property="shipTime" column="ship_time" />
        <result property="receiveTime" column="receive_time" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <sql id="Base_Column_List">
        id, order_no, user_id, status, total_amount,
        receiver_name, receiver_phone, receiver_address,
        pay_time, ship_time, receive_time, create_time, update_time
    </sql>

    <select id="selectById" parameterType="long" resultMap="OrderResultMap">
        SELECT <include refid="Base_Column_List"/> FROM order_table WHERE id = #{id}
    </select>

    <select id="selectByIdAndUserId" resultMap="OrderResultMap">
        SELECT <include refid="Base_Column_List"/> FROM order_table WHERE id = #{id} AND user_id = #{userId}
    </select>

    <insert id="insert" parameterType="com.neusoft.coursemgr.domain.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO order_table (
            order_no, user_id, status, total_amount,
            receiver_name, receiver_phone, receiver_address
        ) VALUES (
            #{orderNo}, #{userId}, #{status}, #{totalAmount},
            #{receiverName}, #{receiverPhone}, #{receiverAddress}
        )
    </insert>

    <update id="updateStatus">
        UPDATE order_table
        SET status = #{toStatus},
            pay_time = IF(#{toStatus}='PENDING_SHIP', NOW(), pay_time),
            ship_time = IF(#{toStatus}='PENDING_RECEIVE', NOW(), ship_time),
            receive_time = IF(#{toStatus}='COMPLETED', NOW(), receive_time)
        WHERE id = #{id}
          AND user_id = #{userId}
          AND status = #{fromStatus}
    </update>

    <update id="adminUpdateStatus">
        UPDATE order_table
        SET status = #{toStatus},
            ship_time = IF(#{toStatus}='PENDING_RECEIVE', NOW(), ship_time)
        WHERE id = #{id}
          AND status = #{fromStatus}
    </update>

    <select id="selectByUserId" resultMap="OrderResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM order_table
        WHERE user_id = #{userId}
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY id DESC
    </select>

    <select id="selectAdminList" resultMap="OrderResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM order_table
        <where>
            <if test="status != null and status != ''">
                status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                <if test="status != null and status != ''">
                    AND
                </if>
                (order_no LIKE CONCAT('%', #{keyword}, '%')
                OR receiver_name LIKE CONCAT('%', #{keyword}, '%')
                OR receiver_phone LIKE CONCAT('%', #{keyword}, '%')
                OR receiver_address LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY id DESC
    </select>

</mapper>
