<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.neusoft.coursemgr.mapper.OrderItemMapper">

    <resultMap id="OrderItemResultMap" type="com.neusoft.coursemgr.domain.OrderItem">
        <id property="id" column="id" />
        <result property="orderId" column="order_id" />
        <result property="productId" column="product_id" />
        <result property="productName" column="product_name" />
        <result property="productCoverUrl" column="product_cover_url" />
        <result property="unitPrice" column="unit_price" />
        <result property="quantity" column="quantity" />
        <result property="amount" column="amount" />
        <result property="createTime" column="create_time" />
    </resultMap>

    <insert id="insertBatch">
        INSERT INTO order_item_table
        (order_id, product_id, product_name, product_cover_url, unit_price, quantity, amount)
        VALUES
        <foreach collection="items" item="it" separator=",">
            (#{orderId}, #{it.productId}, #{it.productName}, #{it.productCoverUrl}, #{it.unitPrice}, #{it.quantity}, #{it.amount})
        </foreach>
    </insert>

    <select id="selectByOrderId" resultMap="OrderItemResultMap">
        SELECT id, order_id, product_id, product_name, product_cover_url, unit_price, quantity, amount, create_time
        FROM order_item_table
        WHERE order_id = #{orderId}
        ORDER BY id ASC
    </select>

    <select id="selectByOrderIdAndUserId" resultMap="OrderItemResultMap">
        SELECT oi.id, oi.order_id, oi.product_id, oi.product_name, oi.product_cover_url, oi.unit_price, oi.quantity, oi.amount, oi.create_time
        FROM order_item_table oi
        JOIN order_table o ON o.id = oi.order_id
        WHERE oi.order_id = #{orderId}
          AND o.user_id = #{userId}
        ORDER BY oi.id ASC
    </select>

    <select id="countOrderItem" resultType="int">
        SELECT COUNT(1)
        FROM order_item_table
        WHERE order_id = #{orderId}
          AND product_id = #{productId}
    </select>

    <select id="countByProductId" resultType="int">
        SELECT COUNT(1)
        FROM order_item_table
        WHERE product_id = #{productId}
    </select>

</mapper>
